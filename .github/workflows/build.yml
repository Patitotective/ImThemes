name: Upload builds to release

on:
  workflow_dispatch: 
  release: 
    types: [released]

jobs:
  build-appimage:
    name: Build and upload amd64 AppImages
    runs-on: ubuntu-22.04 # Oldest ubuntu possible to make the AppImage as compatible as possible

    steps:
      - uses: actions/checkout@v4
      - uses: iffy/install-nim@v5
      - name: Install x11 dev libraries
        run: sudo apt install libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev libgl-dev libfuse2
      - name: Build AppImage
        run: |
          nimble install -d -y
          nimble c -r build.nim

      - uses: oprypin/find-latest-tag@v1
        id: latest-tag  # The step ID to refer to later.
        with:
          repository: ${{ github.repository }}  # The repository to scan.
          releases-only: true  # We know that all relevant tags have a GitHub release for them.
    
      - name: Upload AppImage
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "ImThemes*.AppImage"
          file_glob: true
          tag: ${{ steps.latest-tag.outputs.tag }}
          overwrite: true

      - name: Upload AppImage.zsync
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "ImThemes*.AppImage.zsync"
          file_glob: true
          tag: ${{ steps.latest-tag.outputs.tag }}
          overwrite: true

  build-win: 
    name: Build and upload amd64 exe
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4
      - uses: iffy/install-nim@v5
      - name: Build exe
        run: |
          nimble install -d -y
          nimble c -r build.nim

      - uses: oprypin/find-latest-tag@v1
        id: latest-tag  # The step ID to refer to later.
        with:
          repository: ${{ github.repository }}  # The repository to scan.
          releases-only: true  # We know that all relevant tags have a GitHub release for them.
    
      - name: Upload zip
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "*.zip"
          file_glob: true
          tag: ${{ steps.latest-tag.outputs.tag }}
          overwrite: true

